# ===============================================
# Dockerfile RÁPIDO - Multi-stage otimizado
# ===============================================
# Usa cache de layers de forma inteligente
# ===============================================

FROM node:20-alpine AS base
RUN corepack enable && corepack prepare pnpm@latest --activate

# ===============================================
# Stage 1: Dependencies - Instala APENAS se package.json mudar
# ===============================================
FROM base AS deps
WORKDIR /app

# Copiar APENAS arquivos de dependências (cache layer)
COPY package.json pnpm-workspace.yaml ./

# Copiar packages completos (necessário para workspace)
COPY packages ./packages

# Instalar dependências (este layer será cacheado!)
# Sem --frozen-lockfile pois lock file não existe
RUN --mount=type=cache,target=/root/.local/share/pnpm/store \
    pnpm install --no-frozen-lockfile --prefer-offline

# ===============================================
# Stage 2: Builder - Build apenas se código mudar
# ===============================================
FROM base AS builder
WORKDIR /app

# Copiar package files e node_modules do stage anterior (cache!)
COPY --from=deps /app/package.json /app/pnpm-workspace.yaml ./
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/packages ./packages

# Copiar arquivos de configuração
COPY next.config.ts tsconfig.json ./
COPY .eslintrc.js .prettierrc.cjs .stylelintrc.cjs ./
COPY drizzle.config.ts next-env.d.ts ./

# CRITICAL FIX: Force remove ANY turbopack config (cache might have old version!)
RUN sed -i '/turbopack.*:/d' next.config.ts && \
    sed -i '/turbopack.*{/d' next.config.ts && \
    echo "✅ Turbopack config forcefully removed from next.config.ts"

# Copiar código fonte
COPY src ./src
COPY public ./public
COPY scripts ./scripts

# Copiar locales (necessário para i18n em runtime)
COPY locales ./locales

# Copiar apps/desktop/package.json (usado por ElectronIPCClient)
RUN mkdir -p apps/desktop
COPY apps/desktop/package.json ./apps/desktop/package.json

# Build args
ARG NEXT_PUBLIC_ENABLE_CUSTOM_AUTH=1
ARG NEXT_PUBLIC_CUSTOM_API_BASE_URL
ARG KEY_VAULTS_SECRET
ARG DATABASE_URL=postgresql://fake:fake@localhost:5432/fake

# Environment variables
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_ENV=production
ENV NEXT_PUBLIC_ENABLE_CUSTOM_AUTH=${NEXT_PUBLIC_ENABLE_CUSTOM_AUTH}
ENV NEXT_PUBLIC_CUSTOM_API_BASE_URL=${NEXT_PUBLIC_CUSTOM_API_BASE_URL}
ENV KEY_VAULTS_SECRET=${KEY_VAULTS_SECRET}
ENV DATABASE_URL=${DATABASE_URL}
ENV DISABLE_MODEL_DOWNLOAD=1
ENV OLLAMA_DISABLED=1
ENV ENABLE_OLLAMA_PROXY=0
# Force Webpack (não Turbopack) em produção
ENV TURBO_FORCE=0

# Build (pulando type-check para evitar erros de módulos não usados)
# Next.js 16: Must explicitly specify --webpack flag (Turbopack is default!)
RUN pnpm run prebuild:docker && \
    NODE_OPTIONS=--max-old-space-size=6144 DOCKER=true pnpm exec next build --webpack && \
    pnpm run build-sitemap

# ===============================================
# Stage 3: Runner - Imagem final mínima
# ===============================================
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3210
ENV DISABLE_MODEL_DOWNLOAD=1
ENV OLLAMA_DISABLED=1
ENV ENABLE_OLLAMA_PROXY=0

# Criar usuário
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# Copiar apenas arquivos necessários
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3210

ENV HOSTNAME="0.0.0.0"

CMD ["node", "server.js"]

